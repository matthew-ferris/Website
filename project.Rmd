---
title: "Using Machine Learning Classification Techniques to Predict Going Concern Opinions"
author: "Matt Ferris"
date: "November 26, 2021"
output: 
  distill::distill_article
---

```{r Load Libraries,include=FALSE,echo=FALSE,message=FALSE,warning=FALSE}
library(lattice)
library(ggplot2)
library(caret)
library(tidyverse)
library(corrplot)
library(stringr)
library(RANN)
```

```{r Load Data, message=FALSE, include=FALSE, warning=FALSE,echo=FALSE}
setwd("~/Desktop/Analytics/Website")

Data<-read.csv("Data.csv",na.strings = ".")
attach(Data)
Data$GOING_CONCERN<-as.factor(Data$GOING_CONCERN)
```

Using data obtained through Dr. Berglund at Mississippi State University, I plan on using machine learning to classify the likelihood that a Going Concern opinion will be issued by an auditor. The data include attributes such as current and prior year cash flows, revenues, net income, shares outstanding, total assets, company book value, and total audit fees.  

To get started, I wanted to see the distribution of the dependent variable, which would be the Going Concern attribute. 

```{r Dependent Variable Distribution Pt. 1, echo=TRUE}
table(Data$GOING_CONCERN)
```

You can see that the distribution is very heavily skewed. Of the nearly 56,000 observations, just under 6,500 of them issued a Going Concern opinion. 

After reviewing the dataset some more, I noticed that there were a relatively large amount of NAs in the observations. Using this formula, you can see the percentage of the data that is NA. 

```{r How much NA?, echo=TRUE}
sum(is.na(Data))/prod(dim(Data))
```

You can see that roughly 10.5% of the cells are NA. There are a few ways to continue, such as different imputation techniques to make "estimates" of what those empty cells should be. However, for the sake of not murdering my computer, I have elected to simply omit NAs from the data. 

```{r Remove NAs, echo=TRUE}
Data<-na.omit(Data)
```

After omitting the NAs, I wanted to see the new distribution of the dependent variable. 

```{r Dependent Variable Distribution Pt. 2, echo=TRUE}
table(Data$GOING_CONCERN)
```

The dataset has now been reduced from 56,000 observations to 40,500. Of those entries removed, a large percentage of them were those that had Going Concern opinions.

**Note: Do I need to over-sample? Such as using SMOTE or a similar function?**

To use machine learning to make the prediction of whether a Going Concern will be issued, I will use K-Nearest Neighbors classification. In short, K-NN attempts to use independent variables to make a prediction of what the dependent variable will be. In this case, the algorithm will predict whether a Going Concern opinion was issued by the company's auditor. The algorithm does this by measuring the distance between the "test data," which is what we are trying to predict, and the "training data." The model then makes a prediction based on the nearest data points in the training data. 

First, I will need to partition the data into two different sets: the first as a "training" set, which 'trains' the algorithm, and the second as a "testing" set, which will be used to test the fit of the model. Using the KNN method to make the predictions, I will then visualize the results in a confusion matrix. 

```{r Knn Classification,message=FALSE,warning=FALSE}
#split the test/train data
trainIndex <- createDataPartition(Data$GOING_CONCERN, p = .5, list = FALSE, times = 1)
#grab the data
DataTrain <- Data[ trainIndex,]
DataTest  <- Data[-trainIndex,]

preProcValues <- preProcess(DataTrain, method = c("center", "scale"))
trainTransformed <- predict(preProcValues, DataTrain)

preProcValues <- preProcess(DataTest, method = c("center", "scale"))
testTransformed <- predict(preProcValues, DataTest)

knn_fit<-train(GOING_CONCERN~MATCHFY_BALSH_ASSETS+MATCHFY_BALSH_BOOK_VAL+MATCHFY_CSHFLST_CHANGE_TTM+MATCHFY_CSHFLST_OP_ACT_TTM+MATCHFY_INCMST_NETINC_TTM+PRIORFY_INCMST_NETINC_TTM+PRIORFY_BALSH_BOOK_VAL+MATCHFY_SUM_AUDFEES+PRIORFY_SUM_AUDFEES+CIK_Code,
               data=trainTransformed,
               method="knn",
               tuneGrid=data.frame(k=4))

knn_pred<-predict(knn_fit,testTransformed)
ConfusionMatrix<-confusionMatrix(knn_pred,testTransformed$GOING_CONCERN)
```

Here is a quick glance at what the model predicted vs. what actually occurred: 

```{r Confusion Matrix Table, echo=FALSE}
ggplot(as.data.frame(ConfusionMatrix$table))+
  geom_raster(aes(x=Reference, y=Prediction, fill=Freq))+
  geom_text(aes(x=Reference, y=Prediction, label=Freq))+
  scale_fill_gradient(low = "palegreen", high = "palegreen4", na.value = "black", name="Frequency")+
  scale_x_discrete(name="Actual Class")+
  scale_y_discrete(name = "Predicted Class")+
  ggtitle("Confusion Matrix")+
  theme(plot.title = element_text(hjust = 0.5, size = 10, face = 'bold'))
```

And here are some more specific statistics: 

```{r confusion matrix stats, echo=FALSE, include=TRUE}
ConfusionMatrix
```

We can see that this model did not perform *spectacularly*. Although there are high accuracy and sensitivity statistics, the specificity statistic is abysmal. This is likely due to the data limitations and not having a direct correlation between the independent variables and the dependent variable. Other variables, even those that are not numerically measured, such as conversations with company personnel, have a large role in whether a Going Concern opinion is issued. 

However, this model could be used to help identify those companies that are more likely to have a Going Concern issue. This model could help to reduce the likelihood of a type 2 error, which is when the auditor falsely accepts the financial statements, when they should have issued a Going Concern opinion. 

The following plot illustrates the variables that the model deemed as the most important. Balance sheet assets, cash flows from operating activities, balance sheet book value, net income, and total audit fees were the most important variables used. 

```{r, echo=FALSE, include=TRUE}
plot(varImp(knn_fit),top = 9,main = "Importance of Variables")
```


```{r cluster analysis,include=FALSE,echo=FALSE,message=FALSE,warning=FALSE, eval=FALSE}
#cluster
#trainTransformed<-subset(trainTransformed,select = -c(AUDITOR_STATE))
Clusters<-kmeans(trainTransformed,centers=4)
Clusterdata<-trainTransformed
Clusterdata$Cluster<-as.factor(Clusters$cluster)

ggplot(data=Clusterdata,mapping = aes(x=MATCHFY_CSHFLST_OP_ACT_TTM,y=MATCHFY_INCMST_NETINC_TTM,color=Cluster))+geom_point(alpha=0.5)

ggplot(data=Clusterdata,mapping = aes(x=MATCHFY_CSHFLST_OP_ACT_TTM,y=MATCHFY_INCMST_NETINC_TTM,color=Cluster))+geom_point(alpha=0.5)+facet_wrap(~GOING_CONCERN)
```


